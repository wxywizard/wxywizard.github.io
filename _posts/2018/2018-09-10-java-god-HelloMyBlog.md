---
layout: post
title: 教你搭建个人博客
category: javagod
no-post-nav: true
tags: [javagod]
keywords: Spring Boot,Memcached
excerpt: Spring Boot 和 Memcached 的解决方案
---


## 你好

我想测试。

## 迁移需求

原来图片服务使用技术为A，随着图片慢慢越来越多，使用的A技术带来的弊端越来越多，后来了解到技术B，技术B目前各各方面都挺好，也满足要求，现在就有一个难题，如何使得目前图片服务由原来的A切换到B呢？由于技术A实现和技术B实现方式区别，图片存储方式都进行了变化，需要进行迁移到B实现方式上面，并且需要做到不间断，持续提供服务。由于真实比较复杂，简单抽象下：

- 图片具体文件存储在用技术A实现的目录下面。
- 所有的图片元信息存储在数据库里面。
- 有N多地方会操作这个元信息表。
- 很多图片地址可能被收录了。
- 可能有些手机版本用户没有升级，一直用老版本情况。

需要换一个图片实现技术B，但是上面的这些问题都需要考虑，并且需要做到不间断，持续提供服务。主要使用图片技术B之后图片技术A的图片存放地方变了，导致元信息表里面的某些字段也需要由于技术B的改动而改动。

## 如何做？

### 针对跳转问题

我们可以把图片资源拿到服务本地，在流写回去（性能不好，并且如果并发各各方面大的话，本次磁盘可能不够，还有一个新的问题存放在本地磁盘的文件什么时候删除呢？ 都是问题）？？？

Nginx代理可以实现跳转并且地址栏不用变化（proxy_pass）。



### 双写

只有双写才会达到追上，所以必须双写（可能会考虑如果写第一个成功，第二个失败，没关系，后续还有扫描操作补数据），需要建立和原来的元信息表字段一样的表，表面后面多加一个_new即可。修改老服务（在里面添加发送请求到新的，达到双写目的），这样补齐原来老的图片即可。

**SQL语句查询数据在A表而不再B表的数据：**

```
select a.id from a left join b on a.id = b.id where b.id is null
```

通过这样可以不断扫表把数据入到新的图片服务以及新表，把历史数据补齐了。

### 切查看再切上传

既然老的地址已经做了代理了，那么先切查看还是先切换上传无所谓了（由于老是查看以及走了新的查看了，所以**本质还是需要先切查看**）。

各各服务切换新的服务上传接口和查看地址前缀（如果走统一配置就很快，如果走配置文件就一个一个服务走）。

> **备注：**由于表不能修改，或者字段不能修改，调用方太多，那么意味着新服务也是写老表。
